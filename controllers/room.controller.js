/**
 * @fileoverview Controller for Room-related operations
 */
import Room from '../models/Room.js';
import { v4 as uuidv4 } from 'uuid';

/**
 * Helper function to ensure a room has an id field
 * If the room doesn't have an id, generate one and save it
 */
async function ensureRoomHasId(room) {
  if (!room.id) {
    room.id = uuidv4();
    await room.save();
  }
  return room;
}

/**
 * Create a new room record
 * Expects body: { title, description, type, pricePerNight, maxPeople, amenities, photos }
 * Note: id is auto-generated by the model using UUID
 */
export const createRoom = async (req, res) => {
  try {
    const { title, description, type, pricePerNight, maxPeople, amenities, photos, thumbnailPic, isAvailable } = req.body;

    // Basic validation
    if (!title || !description || !type || !pricePerNight || !maxPeople) {
      return res.status(400).json({ message: 'Missing required room fields' });
    }

    // photos is expected to be an array of { url, publicId, originalName }
    // id is auto-generated by the model
    const newRoom = new Room({
      title,
      description,
      type,
      pricePerNight,
      maxPeople,
      amenities: amenities || [],
      photos: photos || [],
      thumbnailPic: thumbnailPic || undefined,
      isAvailable: typeof isAvailable === 'boolean' ? isAvailable : true
    });

    await newRoom.save();
    return res.status(201).json({ message: 'Room created', room: newRoom });
  } catch (err) {
    console.error('createRoom error:', err);
    return res.status(500).json({ message: err.message || 'Server error' });
  }
};

/**
 * Get list of rooms
 * Optional query: ?available=true
 */
export const getRooms = async (req, res) => {
  try {
    const { available } = req.query;
    const filter = {};
    if (available === 'true') filter.isAvailable = true;
    if (available === 'false') filter.isAvailable = false;

    let rooms = await Room.find(filter).sort({ createdAt: -1 });
    
    // Ensure all rooms have an id field
    rooms = await Promise.all(rooms.map(room => ensureRoomHasId(room)));
    
    return res.status(200).json({ rooms });
  } catch (err) {
    console.error('getRooms error:', err);
    return res.status(500).json({ message: err.message || 'Server error' });
  }
};

/**
 * Get a single room by id (UUID or MongoDB id)
 */
export const getRoomById = async (req, res) => {
  try {
    const { id } = req.params;
    
    // Try to find by custom id field first (UUID)
    let room = await Room.findOne({ id });
    
    // If not found and id looks like a MongoDB ObjectId, try findById
    if (!room && id.match(/^[0-9a-fA-F]{24}$/)) {
      try {
        room = await Room.findById(id);
      } catch (err) {
        // If findById fails, just return null
        room = null;
      }
    }
    
    if (!room) {
      return res.status(404).json({ message: 'Room not found' });
    }

    // Ensure the room has an id field
    room = await ensureRoomHasId(room);

    return res.status(200).json({ room });
  } catch (err) {
    console.error('getRoomById error:', err);
    return res.status(500).json({ message: err.message || 'Server error' });
  }
};

/**
 * Update a room by id (UUID or MongoDB id)
 */
export const updateRoom = async (req, res) => {
  try {
    const { id } = req.params;
    const { title, description, type, pricePerNight, maxPeople, amenities, photos, thumbnailPic, isAvailable } = req.body;

    // Validate at least one field is provided
    if (!title && !description && !type && !pricePerNight && !maxPeople && !amenities && !photos && !thumbnailPic && isAvailable === undefined) {
      return res.status(400).json({ message: 'No fields to update' });
    }

    const updateData = {};
    if (title) updateData.title = title;
    if (description) updateData.description = description;
    if (type) updateData.type = type;
    if (pricePerNight !== undefined) updateData.pricePerNight = pricePerNight;
    if (maxPeople) updateData.maxPeople = maxPeople;
    if (amenities) updateData.amenities = amenities;
    if (photos) updateData.photos = photos;
    if (thumbnailPic) updateData.thumbnailPic = thumbnailPic;
    if (isAvailable !== undefined) updateData.isAvailable = isAvailable;

    // Try to update by custom id field first (UUID), then fall back to MongoDB _id
    let room = await Room.findOneAndUpdate({ id }, updateData, { new: true });
    
    // If not found and id looks like a MongoDB ObjectId, try findByIdAndUpdate
    if (!room && id.match(/^[0-9a-fA-F]{24}$/)) {
      try {
        room = await Room.findByIdAndUpdate(id, updateData, { new: true });
      } catch (err) {
        // If findByIdAndUpdate fails, just return null
        room = null;
      }
    }

    if (!room) {
      return res.status(404).json({ message: 'Room not found' });
    }

    return res.status(200).json({ message: 'Room updated', room });
  } catch (err) {
    console.error('updateRoom error:', err);
    return res.status(500).json({ message: err.message || 'Server error' });
  }
};

/**
 * Delete a room by id (UUID or MongoDB id)
 */
export const deleteRoom = async (req, res) => {
  try {
    const { id } = req.params;
    let room = await Room.findOneAndDelete({ id });
    if (!room && id.match(/^[0-9a-fA-F]{24}$/)) {
      room = await Room.findByIdAndDelete(id);
    }
    if (!room) {
      return res.status(404).json({ message: 'Room not found' });
    }
    return res.status(200).json({ message: 'Room deleted', room });
  } catch (err) {
    console.error('deleteRoom error:', err);
    return res.status(500).json({ message: err.message || 'Server error' });
  }
};
