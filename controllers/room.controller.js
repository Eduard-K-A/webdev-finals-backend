/**
 * @fileoverview Controller for Room-related operations
 */
import Room from '../models/Room.js';

/**
 * Create a new room record
 * Expects body: { title, description, type, pricePerNight, maxPeople, amenities, photos }
 * Note: id is auto-generated by the model using UUID
 */
export const createRoom = async (req, res) => {
  try {
    const { title, description, type, pricePerNight, maxPeople, amenities, photos, thumbnailPic, isAvailable } = req.body;

    // Basic validation
    if (!title || !description || !type || !pricePerNight || !maxPeople) {
      return res.status(400).json({ message: 'Missing required room fields' });
    }

    // photos is expected to be an array of { url, publicId, originalName }
    // id is auto-generated by the model
    const newRoom = new Room({
      title,
      description,
      type,
      pricePerNight,
      maxPeople,
      amenities: amenities || [],
      photos: photos || [],
      thumbnailPic: thumbnailPic || undefined,
      isAvailable: typeof isAvailable === 'boolean' ? isAvailable : true
    });

    await newRoom.save();
    return res.status(201).json({ message: 'Room created', room: newRoom });
  } catch (err) {
    console.error('createRoom error:', err);
    return res.status(500).json({ message: err.message || 'Server error' });
  }
};

/**
 * Get list of rooms
 * Optional query: ?available=true
 */
export const getRooms = async (req, res) => {
  try {
    const { available } = req.query;
    const filter = {};
    if (available === 'true') filter.isAvailable = true;
    if (available === 'false') filter.isAvailable = false;

    const rooms = await Room.find(filter).sort({ createdAt: -1 });
    return res.status(200).json({ rooms });
  } catch (err) {
    console.error('getRooms error:', err);
    return res.status(500).json({ message: err.message || 'Server error' });
  }
};

/**
 * Get a single room by id (UUID or MongoDB id)
 */
export const getRoomById = async (req, res) => {
  try {
    const { id } = req.params;
    
    // Try to find by custom id field first (UUID), then fall back to id
    let room = await Room.findOne({ id });
    if (!room) {
      room = await Room.findById(id);
    }
    
    if (!room) {
      return res.status(404).json({ message: 'Room not found' });
    }

    return res.status(200).json({ room });
  } catch (err) {
    console.error('getRoomById error:', err);
    return res.status(500).json({ message: err.message || 'Server error' });
  }
};

/**
 * Update a room by id (UUID or MongoDB id)
 */
export const updateRoom = async (req, res) => {
  try {
    const { id } = req.params;
    const { title, description, type, pricePerNight, maxPeople, amenities, photos, isAvailable } = req.body;

    // Validate at least one field is provided
    if (!title && !description && !type && !pricePerNight && !maxPeople && !amenities && !photos && isAvailable === undefined) {
      return res.status(400).json({ message: 'No fields to update' });
    }

    const updateData = {};
    if (title) updateData.title = title;
    if (description) updateData.description = description;
    if (type) updateData.type = type;
    if (pricePerNight !== undefined) updateData.pricePerNight = pricePerNight;
    if (maxPeople) updateData.maxPeople = maxPeople;
    if (amenities) updateData.amenities = amenities;
    if (photos) updateData.photos = photos;
    if (thumbnailPic) updateData.thumbnailPic = thumbnailPic;
    if (isAvailable !== undefined) updateData.isAvailable = isAvailable;

    // Try to update by custom id field first (UUID), then fall back to id
    let room = await Room.findOneAndUpdate({ id }, updateData, { new: true });
    if (!room) {
      room = await Room.findByIdAndUpdate(id, updateData, { new: true });
    }

    if (!room) {
      return res.status(404).json({ message: 'Room not found' });
    }

    return res.status(200).json({ message: 'Room updated', room });
  } catch (err) {
    console.error('updateRoom error:', err);
    return res.status(500).json({ message: err.message || 'Server error' });
  }
};
